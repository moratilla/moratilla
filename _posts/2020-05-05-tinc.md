---
layout: post
title: tinc as VPN service
categories: [network, security]
---

![Xmas tree at Hospital La Paz](/assets/img/20201213_hlpaz-min.jpg){:.lead}


I have been using [tinc VPN](https://www.tinc-vpn.org/) in my laboratory for
 the last months to support the communications between my nodes.  I have learn 
 that it is a stable solution for anyone looking to create a VPN mesh between 
 several nodes where any node can connect against the others.  This is great 
 for a decentralized cluster, like corosync (used in Proxmox VE).

That is why I'm going to talk today about tinc and how to setup it and which
 problems can you find and how to solve them.

## Introduction to tinc

* [Official Website for tinc](https://www.tinc-vpn.org/)
* [Github Repository](https://github.com/gsliepen/tinc)

tinc is a Virtual Private Network daemon that creates secure private networks between hosts on the Internet.  It is fast and simpler than OpenVPN or FreeSWAN.

Its main developer is [Guus Sliepen](https://github.com/gsliepen/), and it has been around since 1998 up to these days.

## Why tinc

Here are my reasons to use tinc instead other solutions:

- Small package: 150kB of binary with 2-5 MB in memory
- Several configurations: client - server, gateway - gateway, mesh (later on this)
- Easy profile generation and maintenance of keys
- Support for routing and switch modes
- Multiple virtual networks at once, just change the port
- It is used by the Chaos Computer Club for their [ChaosVPN](https://wiki.hamburg.ccc.de/ChaosVPN:DebianHowto)

And the last one, not so relevant:
- Multiple platform support: Linux, FreeBSD (and MacOS), Windows

Things I don't like:

- It's old: it's a piece of software created in 1998, but it is updated (last release 1.0.36 dated Aug 29th 2019)

## Installing from packages

In debian / ubuntu, just install it with apt tools

    $ sudo apt update
    $ sudo apt-get install -y tinc

It will install the binary in /usr/sbin/tincd, will create a subdirectory
 under /etc/tinc and a default config file under /etc/default/tinc.

## Configuration

The configuration of a virtual private network is very simple, as they are 4 easy steps.

__1. Create a subdirectory structure under /etc/tinc for storing the configuration__

This subdirectory name will be used as the name of the virtual private network.  Also a subdirectory called hosts must be created under the main subdirectory to store the profiles of the peers involved in the network.

__2. Create tinc.conf plus up and down scripts__

__2.1. tinc.conf__

This file contains the kind of mode of VPN to be used, the port to connect to and the peers of the tunnel.

Example routing configuration:

    Name = home
    AddressFamily = ipv4
    Interface = tun0
    ConnectTo = server
    Port = 655

* __Name__: is the name of the present node.
* __AddressFamily__: (ipv4, ipv6) in case of routing mode, which kind of network will be used.
* __Interface__: tun0 is the default virtual network interface for a network layer device (see [tun/tap at Wikipedia](https://en.wikipedia.org/wiki/TUN/TAP)).
* __ConnectTo__: (Multiple instances) The peer of this connection.  It can be repeated to set a multiple peer VPN.

    ~~~
    ConnectTo = server1
    ConnectTo = server2
    ConnectTo = ...
    ~~~

* __Port__: TCP/UDP port to connect to.  Default is 656, but if you want to set up multiple configurations, you will need to change the port to connect to.

Example bridge configuration:

    Name = home
    Mode = switch
    ConnectTo = server
    Port = 655

The only difference is the Mode parameter.

* __Mode__: (default 'router'), but it accepts 'switch' and 'hub' for bridge configurations.

__2.2. Up and down scripts__

These scripts (tinc-up and tinc-down) are automatically launched when the VPN starts of shutdowns.  They are used to perform actions after the interface is up or down.

__2.2.1. Routing example__

    tinc-up:
    #!/bin/sh
    ifconfig $INTERFACE 10.0.0.1 netmask 255.255.255.0

    tinc-down:
    #!/bin/sh
    ifconfig $INTERFACE  down

__2.2.2. Bridge example__

    tinc-up:
    #!/bin/sh
    ifconfig $INTERFACE 0.0.0.0
    brctl addif vmbr0 $INTERFACE
    ifconfig $INTERFACE up

    tinc-down:
    #!/bin/sh
    ifconfig $INTERFACE down
    brctl delif vmbr0 $INTERFACE

__3. Generate profiles__

Each peer of the virtual private network must have an unique name and a key pair to identify against the others.  Also each node can set some parameters to set the network topology to use after the tunnel has been established.

The profile is a file under the hosts/ subdirectory created in step 1.  It must has the same name as the Name parameter set in the tinc.conf file (see step 2.1).  This file will contain info about how to connect to the host and the network behind.

The profile file also contains a RSA public key generated by the tincd command.  This key is needed to authenticate the peer.

To generate the key pair, for each node in the network, execute the following command:

    # tincd -n <vpn-name> -K <size>

Where vpn-name is the name of the subdirectory storing the configuration, and the size is the size of the key pair (recommended 4096 or higher).

This command will generate two files: rsa_key.priv and rsa_key.pub.  The second file may not be created but added into the local profile under hosts/ subdirectory automatically.

__4. Exchange profiles__

The profile file under hosts/ subdirectory must be sent to the remote server in order to be used as the authentication key when the tunnel is being established.

You can use scp or any other command to copy the profile to the remote host and install it under the hosts/ subdirectory.  When all the profiles are set correctly, then you can launch the tincd process.

## Execution

### Manual execution (for debugging purposes)

Use the following command in each node to test the connectivity:

    $ sudo tincd -D -n <vpn-name> &

This will launch the daemon in foreground and you will be able to see the logs.

### Service execution (systemd)

Execute the following commands to enable and start the tinc daemon for the specific vpn instance:

    $ sudo systemctl enable tinc@vpn-name
    $ sudo systemctl start tinc@vpn-name

To see the new interface created, just execute a ip add show (or ifconfig) command to show the configuration

    4: internalvpn: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master vmbr1 state UNKNOWN group default qlen 1000
    link/ether ea:92:5d:a8:ef:71 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::e892:5dff:fea8:ef71/64 scope link
       valid_lft forever preferred_lft forever

As you can see, the interface gets its name from the name of the VPN instance.


## Scenarios

For these configurations, I have used the minimum allowed variables for a successful configuration.  Check the [tinc manual entry](https://www.tinc-vpn.org/documentation/Main-configuration-variables.html#Main-configuration-variables) to learn more about configuration variables.

### __1. Client to Server__

![Diagram of a Client to Server configuration](/assets/img/vpn_client_2_server.png){:.lead}
Diagram of a Client to Server configuration
{:.figure}

Typical scenario for somebody working remotely.  A user runs a tinc instance
 in her laptop to connect to her work.  She gets an VPN IP address that it is
 managed by the router that manages connections and internal routes.

The customer has no complications, just identifies itself and only needs the profile of the server.

__1.1. tinc.conf__

__1.1.1. Client__

    Name = roadwarrior
    ConnectTo = office
    Port = 655

__1.1.2. Server__

    Name = office
    AddressFamily = ipv4
    Interface = tun0


__1.2. Profile__

__1.2.1. Client__

    <RSA PUBLIC KEY>

__1.2.2. Server__

    Address = <External IP>
    Subnet = 10.0.0.1/8

    <RSA PUBLIC KEY>

### __2. Router to Router/s__

![Diagram of a router to router configuration](/assets/img/vpn_router_2_router.png){:.lead}
Diagram of a router to router configuration
{:.figure}

If your needs are kind of more complex like sending packets between two (or more) offices, then
you need to setup properly the Subnet variable to let tinc know about the networks reachable.


__2.1. tinc.conf__

__2.1.1. Server A__

    Name = servera
    AddressFamily = ipv4
    Interface = tun0
    ConnectTo = serverb
    Port = 655

__2.1.2. Server B__

    Name = serverb
    AddressFamily = ipv4
    Interface = tun0
    ConnectTo = serverA
    Port = 655

__2.2. Profile__

__2.2.1. Server A__


    Address = <External IP>
    Subnet = 172.16.0.1/16

    <RSA PUBLIC KEY>

__2.2.2. Server B__

    Address = <External IP>
    Subnet = 10.0.0.1/8

    <RSA PUBLIC KEY>

### __3. Bridge to Bridge/s with multiple hosts__

![Diagram of a bridge to bridge configuration](/assets/img/vpn_bridge_2_bridge_multi.png){:.lead}
Diagram of a bridge to bridge with multiple hosts configuration
{:.figure}

This case is same than router configuration, but it differs in that the VPN only works as a bridge, and all the IP layer is managed by the interfaces bound to the bridge.  For me, this case is best when I create clusters with virtual machines that could migrate from one host to another keeping the same IP address.

Let's add this time a third server, just to show that tinc can manage multiple hosts VPNs.

I will set the switch mode instead of hub, because I want to avoid useless traffic to flood the VPN interface.

__3.1. tinc.conf__

__3.1.1. Server A__

    Name = servera
    Mode = switch
    ConnectTo = serverb
    ConnectTo = serverc
    Port = 655

__3.1.2. Server B__

    Name = serverb
    Mode = switch
    ConnectTo = servera
    ConnectTo = serverc
    Port = 655

__3.1.2. Server B__

    Name = serverc
    Mode = switch
    ConnectTo = servera
    ConnectTo = serverb
    Port = 655

__3.2. Profile__

__3.2.1. Server A__

    Address = <External IP>

    <RSA PUBLIC KEY>

__3.2.2. Server B__

    Address = <External IP>

    <RSA PUBLIC KEY>

__3.2.2. Server C__

    Address = <External IP>

    <RSA PUBLIC KEY>

__3.3. Bridge up-down scripts__

Don't forget to set properly your up / down scripts to bind the VPN interface to your bridges.

    tinc-up:
    #!/bin/sh
    ifconfig $INTERFACE 0.0.0.0
    brctl addif vmbr0 $INTERFACE
    ifconfig $INTERFACE up

    tinc-down:
    #!/bin/sh
    ifconfig $INTERFACE down
    brctl delif vmbr0 $INTERFACE

This ends this monographic about tinc.  I hope somebody will find this useful someday.

